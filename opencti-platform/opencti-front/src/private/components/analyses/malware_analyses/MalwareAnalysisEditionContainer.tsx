import React, { FunctionComponent, useState } from 'react';
import { graphql, PreloadedQuery, usePreloadedQuery } from 'react-relay';
import Box from '@mui/material/Box';
import Tabs from '@mui/material/Tabs';
import Tab from '@mui/material/Tab';
import Drawer, { DrawerVariant } from '@components/common/drawer/Drawer';
import { useFormatter } from '../../../../components/i18n';
import ErrorNotFound from '../../../../components/ErrorNotFound';
import MalwareAnalysisEditionOverview from './MalwareAnalysisEditionOverview';
import { MalwareAnalysisEditionContainerQuery } from './__generated__/MalwareAnalysisEditionContainerQuery.graphql';
import MalwareAnalysisEditionDetails from './MalwareAnalysisEditionDetails';
import { useIsEnforceReference } from '../../../../utils/hooks/useEntitySettings';

interface MalwareAnalysisEditionContainerProps {
  queryRef: PreloadedQuery<MalwareAnalysisEditionContainerQuery>
  handleClose: () => void
  open?: boolean
}

export const malwareAnalysisEditionQuery = graphql`
  query MalwareAnalysisEditionContainerQuery($id: String!) {
    malwareAnalysis(id: $id) {
      ...MalwareAnalysisEditionOverview_malwareAnalysis
      ...MalwareAnalysisEditionDetails_malwareAnalysis
      editContext {
        name
        focusOn
      }
    }
  }
`;
const MalwareAnalysisEditionContainer: FunctionComponent<MalwareAnalysisEditionContainerProps> = ({ queryRef, handleClose, open }) => {
  const { t } = useFormatter();

  const { malwareAnalysis } = usePreloadedQuery(malwareAnalysisEditionQuery, queryRef);

  const [currentTab, setCurrentTab] = useState(0);
  const handleChangeTab = (event: React.SyntheticEvent, value: number) => setCurrentTab(value);

  if (malwareAnalysis === null) {
    return (<ErrorNotFound />);
  }
  return (
    <Drawer
      title={t('Update a malware analysis')}
      variant={open == null ? DrawerVariant.update : undefined}
      context={malwareAnalysis.editContext}
      onClose={handleClose}
      open={open}
    >
      {({ onClose }) => (
        <>
          <Box sx={{ borderBottom: 1, borderColor: 'divider' }}>
            <Tabs
              value={currentTab}
              onChange={handleChangeTab}
            >
              <Tab label={t('Overview')} />
              <Tab label={t('Details')} />
            </Tabs>
          </Box>
          {currentTab === 0 && (
            <MalwareAnalysisEditionOverview
              malwareAnalysisRef={malwareAnalysis}
              context={malwareAnalysis.editContext}
              enableReferences={useIsEnforceReference('Malware-Analysis')}
              handleClose={onClose}
            />
          )}
          {currentTab === 1 && (
            <MalwareAnalysisEditionDetails
              malwareAnalysisRef={malwareAnalysis}
              context={malwareAnalysis.editContext}
              enableReferences={useIsEnforceReference('Malware-Analysis')}
              handleClose={onClose}
            />
          )}
        </>
      )}
    </Drawer>
  );
};

export default MalwareAnalysisEditionContainer;
